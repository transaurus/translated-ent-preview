---
id: ci
title: Continuous Integration
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

为确保软件质量，团队通常会实施持续集成（Continuous Integration，简称CI）工作流。通过CI，团队能针对代码库的每次变更自动运行一系列验证流程。在CI过程中，团队可能执行多种验证：

* 编译或构建最新版本代码，确保其未被破坏。
* 代码静态检查以强制执行公认的代码风格标准。
* 单元测试验证各组件是否按预期工作，并确保代码变更不会导致其他功能退化。
* 安全扫描防止已知漏洞被引入代码库。
* 以及其他更多验证项！

根据与Ent社区的交流，我们了解到许多使用Ent的团队已采用CI流程，并希望在现有工作流中增加Ent专项验证。

为支持社区这一需求，我们编写了本指南，记录CI中应验证的常见最佳实践，并介绍由我们维护的GitHub Action工具[ent/contrib/ci](https://github.com/ent/contrib/tree/master/ci)，该工具将这些实践代码化实现。

## 验证所有生成文件已提交

Ent高度依赖代码生成。根据经验，生成的代码必须始终提交至版本控制系统，原因有二：

* 提交生成的代码后，可随主代码一同审阅。在代码审查或浏览仓库时，生成代码的存在对于完整理解系统工作原理至关重要。
* 能快速发现并修复团队成员开发环境的差异，从而减少"在我机器上能运行"这类问题，确保所有人运行相同代码。

若使用GitHub管理代码，可通过`ent/contrib/ci`的GitHub Action轻松验证生成文件是否全部提交。其他情况下，我们提供简单的bash脚本供集成至现有CI流程。

<Tabs
    defaultValue="gh"
    values={[
        {label: 'GitHub Action', value: 'gh'},
        {label: 'Bash', value: 'bash'},
    ]}>
<TabItem value="gh">
Simply add a file named `.github/workflows/ent-ci.yaml` in your repository:

```yaml
name: EntCI
on:
  push:
  # Run whenever code is changed in the master.
    branches:
      - master
  # Run on PRs where something changed under the `ent/` directory.
  pull_request:
    paths:
      - 'ent/*'
jobs:
  ent:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3.0.1
      - uses: actions/setup-go@v3
        with:
          go-version-file: 'go.mod'
      - uses: ent/contrib/ci@master
```

</TabItem>
<TabItem value="bash">

```bash
go generate ./...
status=$(git status --porcelain)
if [ -n "$status" ]; then
    echo "you need to run 'go generate ./...' and commit the changes"
    echo "$status"
    exit 1
fi
```

</TabItem>
</Tabs>

## 迁移文件静态检查

项目Ent模式的变更几乎总会引发数据库修改。若使用[版本化迁移](/docs/versioned-migrations)管理数据库模式变更，可在CI流程中运行[迁移静态检查](https://atlasgo.io/versioned/lint)，其作用包括：

* 在[开发数据库容器](https://atlasgo.io/concepts/dev-database)上重放迁移目录，确保所有SQL语句有效且顺序正确。
* 强制保障[迁移目录完整性](/docs/versioned-migrations#atlas-migration-directory-integrity-file)，避免历史记录被意外修改，并确保并行规划的迁移最终合并为线性历史。
* 检测破坏性变更，在迁移触及生产环境前预警潜在数据丢失风险。
* 识别数据依赖性变更，这类变更可能在部署时失败，需要额外人工审查。

若使用GitHub，可通过[官方Atlas Action](https://github.com/ariga/atlas-action)在CI中执行迁移静态检查。

在仓库中添加`.github/workflows/atlas-ci.yaml`文件，内容如下：

<Tabs
defaultValue="mysql"
values={[
    {label: 'MySQL', value: 'mysql'},
    {label: 'MariaDB', value: 'maria'},
    {label: 'PostgreSQL', value: 'postgres'},
    {label: 'SQLite', value: 'sqlite'},
]}>
<TabItem value="mysql">

```yaml
name: Atlas CI
on:
  # Run whenever code is changed in the master branch,
  # change this to your root branch.
  push:
    branches:
      - master
  # Run on PRs where something changed under the `ent/migrate/migrations/` directory.
  pull_request:
    paths:
      - 'ent/migrate/migrations/*'
jobs:
  lint:
    services:
      # Spin up a mysql:8.0.29 container to be used as the dev-database for analysis.
      mysql:
        image: mysql:8.0.29
        env:
          MYSQL_ROOT_PASSWORD: pass
          MYSQL_DATABASE: test
        ports:
          - "3306:3306"
        options: >-
          --health-cmd "mysqladmin ping -ppass"
          --health-interval 10s
          --health-start-period 10s
          --health-timeout 5s
          --health-retries 10
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ariga/setup-atlas@v0
        with:
          cloud-token: ${{ secrets.ATLAS_CLOUD_TOKEN }}
      - uses: ariga/atlas-action/migrate/lint@v1
        with:
          dir: 'file://ent/migrate/migrations'
          dir-name: 'my-project' # The name of the project in Atlas Cloud
          dev-url: "mysql://root:pass@localhost:3306/dev"
```

</TabItem>
<TabItem value="maria">

```yaml
name: Atlas CI
on:
  # Run whenever code is changed in the master branch,
  # change this to your root branch.
  push:
    branches:
      - master
  # Run on PRs where something changed under the `ent/migrate/migrations/` directory.
  pull_request:
    paths:
      - 'ent/migrate/migrations/*'
jobs:
  lint:
    services:
      # Spin up a maria:11 container to be used as the dev-database for analysis.
      mariadb:
        image: mariadb:11
        env:
          MYSQL_DATABASE: dev
          MYSQL_ROOT_PASSWORD: pass
        ports:
          - "3306:3306"
        options: >-
          --health-cmd "healthcheck.sh --su-mysql --connect --innodb_initialized"
          --health-interval 10s
          --health-start-period 10s
          --health-timeout 5s
          --health-retries 10
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ariga/setup-atlas@v0
        with:
          cloud-token: ${{ secrets.ATLAS_CLOUD_TOKEN }}
      - uses: ariga/atlas-action/migrate/lint@v1
        with:
          dir: 'file://ent/migrate/migrations'
          dir-name: 'my-project' # The name of the project in Atlas Cloud
          dev-url: "maria://root:pass@localhost:3306/dev"
```

</TabItem>
<TabItem value="postgres">

```yaml
name: Atlas CI
on:
  # Run whenever code is changed in the master branch,
  # change this to your root branch.
  push:
    branches:
      - master
  # Run on PRs where something changed under the `ent/migrate/migrations/` directory.
  pull_request:
    paths:
      - 'ent/migrate/migrations/*'
jobs:
  lint:
    services:
      # Spin up a postgres:15 container to be used as the dev-database for analysis.
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: dev
          POSTGRES_PASSWORD: pass
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-start-period 10s
          --health-timeout 5s
          --health-retries 5
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ariga/setup-atlas@v0
        with:
          cloud-token: ${{ secrets.ATLAS_CLOUD_TOKEN }}
      - uses: ariga/atlas-action/migrate/lint@v1
        with:
          dir: 'file://ent/migrate/migrations'
          dir-name: 'my-project' # The name of the project in Atlas Cloud
          dev-url: postgres://postgres:pass@localhost:5432/dev?sslmode=disable
```

</TabItem>
<TabItem value="sqlite">

```yaml
name: Atlas CI
on:
  # Run whenever code is changed in the master branch,
  # change this to your root branch.
  push:
    branches:
      - master
  # Run on PRs where something changed under the `ent/migrate/migrations/` directory.
  pull_request:
    paths:
      - 'ent/migrate/migrations/*'
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ariga/setup-atlas@v0
        with:
          cloud-token: ${{ secrets.ATLAS_CLOUD_TOKEN }}
      - uses: ariga/atlas-action/migrate/lint@v1
        with:
          dir: 'file://ent/migrate/migrations'
          dir-name: 'my-project' # The name of the project in Atlas Cloud
          dev-url: sqlite://file?mode=memory&_fk=1
```

</TabItem>
</Tabs>

注意运行`atlas migrate lint`需要干净的[开发数据库](https://atlasgo.io/concepts/dev-database)，上述示例代码中的`services`模块即用于提供该环境。