---
title: Using Postgres Extensions in Ent Schema
id: extension
slug: extensions
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import InstallationInstructions from '../components/_installation_instructions.mdx';

[Postgres扩展](https://www.postgresql.org/docs/current/sql-createextension.html)是通过提供新数据类型、操作符、函数、过程语言等功能来增强数据库的附加模块。

本指南将说明如何定义一个使用PostGIS扩展提供的数据类型的模式字段，并通过Atlas配置模式迁移，将Postgres扩展安装与Ent模式作为单一迁移单元进行管理。

:::info[[Atlas Pro功能](https://atlasgo.io/features#pro-plan)]
Atlas对[扩展](https://atlasgo.io/atlas-schema/hcl#extension)的支持仅限Pro用户使用。要使用此功能，请运行：
```
atlas login
```
:::

## 安装Atlas

<InstallationInstructions />

## 登录Atlas

```shell
$ atlas login a8m
//highlight-next-line-info
You are now connected to "a8m" on Atlas Cloud.
```

## 复合模式

`ent/schema`包主要用于定义Ent类型（对象）、字段、边和逻辑。像`postgis`或`hstore`这样的扩展在Ent模式中没有表示形式。Postgres扩展只需在Postgres数据库中安装一次，便可在不同模式中多次使用。

为了将PostgreSQL模式迁移扩展到包括扩展和Ent类型，我们配置Atlas从[复合模式](https://atlasgo.io/atlas-schema/projects#data-source-composite_schema)数据源读取模式状态。按照以下步骤为项目进行配置：

1\. 创建一个`schema.sql`文件，定义数据库所需的扩展。同样，你也可以使用[Atlas Schema HCL语言](https://atlasgo.io/atlas-schema/hcl-types#extension)来定义扩展：

<Tabs>
<TabItem value={"sql"} label={"Using SQL"}>

```sql title="schema.sql"
-- Install PostGIS extension.
CREATE EXTENSION postgis;
```

</TabItem>
<TabItem value={"hcl"} label={"Using HCL"}>

```hcl title="schema.hcl"
schema "public" {}

extension "postgis" {
  schema  = schema.public
  version = "3.4.2"
  comment = "PostGIS geometry and geography spatial types and functions"
}
```

</TabItem>
</Tabs>

2\. 在Ent模式中，定义一个使用扩展提供的数据类型的字段。在本例中，我们使用`postgis`扩展提供的`GEOMETRY(Point, 4326)`数据类型：

```go title="ent/schema/user.go" {7-9}
// Fields of the User.
func (User) Fields() []ent.Field {
	return []ent.Field{
		field.Bytes("location").
			// Ideally, we would use a custom GoType
			// to represent the "geometry" type.
			SchemaType(map[string]string{
				dialect.Postgres: "GEOMETRY(Point, 4326)",
			}),
	}
}
```

3\. 创建一个简单的`atlas.hcl`配置文件，其中包含一个`composite_schema`，该模式同时包括`schema.sql`中定义的扩展和你的Ent模式：

```hcl title="atlas.hcl"
data "composite_schema" "app" {
  # Install extensions first (PostGIS).
  schema "public" {
    url = "file://schema.sql"
  }
  # Then, load the Ent schema.
  schema "public" {
    url = "ent://ent/schema"
  }
}

env "local" {
  src = data.composite_schema.app.url
  dev = "docker://postgis/latest/dev"
  format {
    migrate {
      diff = "{{ sql . \"  \" }}"
    }
  }
}
```

## 使用

设置好复合模式后，我们可以使用`atlas schema inspect`命令获取其表示，为其生成模式迁移，将其应用到数据库等。以下是一些帮助你开始使用Atlas的命令：

#### 检查模式

`atlas schema inspect`命令通常用于检查数据库。不过，我们也可以用它来检查`composite_schema`并打印其SQL表示：

```shell
atlas schema inspect \
  --env local \
  --url env://src \
  --format '{{ sql . }}'
```

上述命令将打印以下SQL。

```sql
-- Add new schema named "public"
CREATE SCHEMA IF NOT EXISTS "public";
-- Set comment to schema: "public"
COMMENT ON SCHEMA "public" IS 'standard public schema';
-- Create extension "postgis"
CREATE EXTENSION "postgis" WITH SCHEMA "public" VERSION "3.4.2";
-- Create "users" table
CREATE TABLE "public"."users" ("id" bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY, "location" public.geometry(point,4326) NOT NULL, PRIMARY KEY ("id"));
```

:::info[扩展是数据库级对象]
尽管`CREATE EXTENSION`命令支持`SCHEMA`参数，但它仅指示扩展对象的安装位置。扩展本身是在数据库级别安装的，无法多次加载到不同的模式中。

因此，为了避免与其他模式冲突，在使用扩展时，迁移的范围应设置为数据库，其中对象使用模式名称限定。因此，在`atlas.hcl`文件中，开发数据库URL中的`search_path`被移除。
:::

#### 为模式生成迁移

要为模式生成迁移，请运行以下命令：

```shell
atlas migrate diff \
  --env local
```

注意，将创建一个新的迁移文件，内容如下：

```sql title="migrations/20240712090543.sql"
-- Create extension "postgis"
CREATE EXTENSION "postgis" WITH SCHEMA "public" VERSION "3.4.2";
-- Create "users" table
CREATE TABLE "public"."users" (
  "id" bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  "location" public.geometry(point,4326) NOT NULL,
  PRIMARY KEY ("id")
);
```

#### 应用迁移

要将上述生成的迁移应用到数据库，请运行以下命令：

```
atlas migrate apply \
  --env local \
  --url "postgres://postgres:pass@localhost:5432/database?search_path=public&sslmode=disable"
```

:::info[直接向数据库应用模式]

有时需要直接将模式应用到数据库而不生成迁移文件。例如，在试验模式变更、为测试启动数据库等场景下，可以使用以下命令直接将模式应用到数据库：

```shell
atlas schema apply \
  --env local \
  --url "postgres://postgres:pass@localhost:5432/database?sslmode=disable"
```

或者使用 [Atlas Go SDK](https://github.com/ariga/atlas-go-sdk)：

```go
ac, err := atlasexec.NewClient(".", "atlas")
if err != nil {
	log.Fatalf("failed to initialize client: %w", err)
}
// 自动用目标模式更新数据库
// 另一种选择是手动使用 'migrate apply' 或 'schema apply'
if _, err := ac.SchemaApply(ctx, &atlasexec.SchemaApplyParams{
	Env: "local",
	URL: "postgres://postgres:pass@localhost:5432/database?sslmode=disable",
	AutoApprove: true,
}); err != nil {
    log.Fatalf("failed to apply schema changes: %w", err)
}
```

:::

本指南的代码可在 [GitHub](https://github.com/ent/ent/tree/master/examples/enumtypes) 获取。