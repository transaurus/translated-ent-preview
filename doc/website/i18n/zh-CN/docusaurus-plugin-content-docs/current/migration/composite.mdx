---
title: Using Composite Types in Ent Schema
id: composite
slug: composite-types
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import InstallationInstructions from '../components/_installation_instructions.mdx';

在PostgreSQL中，复合类型类似于数据行或记录，由字段名及其对应数据类型组成。将Ent字段设置为复合类型后，您可以在单列中存储复杂的结构化数据。

本指南将说明如何在Ent模式中定义复合类型的模式字段，并通过Atlas配置模式迁移，将复合类型与Ent模式作为单一迁移单元进行管理。

:::info[[Atlas Pro功能](https://atlasgo.io/features#pro-plan)]
Atlas对[复合类型](https://atlasgo.io/atlas-schema/hcl#composite-type)的支持仅限专业版用户。使用该功能前请执行：
```
atlas login
```
:::

## 安装Atlas

<InstallationInstructions />

## 登录Atlas

```shell
$ atlas login a8m
//highlight-next-line-info
You are now connected to "a8m" on Atlas Cloud.
```

## 复合模式

`ent/schema`包主要用于定义Ent类型（对象）、其字段、边和逻辑。复合类型或其他数据库对象在Ent模型中并无直接体现——复合类型只需定义一次，即可在不同字段和模型中多次使用。

为扩展PostgreSQL模式以包含自定义复合类型和Ent类型，我们配置Atlas从[复合模式](https://atlasgo.io/atlas-schema/projects#data-source-composite_schema)数据源读取模式状态。按以下步骤为项目进行配置：

1\. 创建定义复合类型的`schema.sql`文件。您也可使用[Atlas模式HCL语言](https://atlasgo.io/atlas-schema/hcl-types#composite-type)配置复合类型：

<Tabs>
<TabItem value={"sql"} label={"Using SQL"}>

```sql title="schema.sql"
CREATE TYPE address AS (
   street text,
   city   text
);
```

</TabItem>
<TabItem value={"hcl"} label={"Using HCL"}>

```hcl title="schema.hcl"
schema "public" {}

composite "address" {
  schema = schema.public
  field "street" {
    type = text
  }
  field "city" {
    type = text
  }
}
```

</TabItem>
</Tabs>

2\. 在Ent模式中定义仅限PostgreSQL方言使用的复合类型字段：

<Tabs>
<TabItem value={"schema"} label={"Schema"}>

```go title="ent/schema/user.go" {6-8}
// Fields of the User.
func (User) Fields() []ent.Field {
	return []ent.Field{
		field.String("address").
			GoType(&Address{}).
			SchemaType(map[string]string{
				dialect.Postgres: "address",
			}),
	}
}
```

:::note
In case a schema with custom driver-specific types is used with other databases, Ent falls back to the default type
used by the driver (e.g., "varchar").
:::
</TabItem>
<TabItem value={"address"} label={"Address Type"}>

```go title="ent/schematype/address.go"
type Address struct {
	Street, City string
}

var _ field.ValueScanner = (*Address)(nil)

// Scan implements the database/sql.Scanner interface.
func (a *Address) Scan(v interface{}) (err error) {
	switch v := v.(type) {
	case nil:
	case string:
		_, err = fmt.Sscanf(v, "(%q,%q)", &a.Street, &a.City)
	case []byte:
		_, err = fmt.Sscanf(string(v), "(%q,%q)", &a.Street, &a.City)
	}
	return
}

// Value implements the driver.Valuer interface.
func (a *Address) Value() (driver.Value, error) {
	return fmt.Sprintf("(%q,%q)", a.Street, a.City), nil
}
```
</TabItem>
</Tabs>

3\. 创建简单的`atlas.hcl`配置文件，通过`composite_schema`同时包含`schema.sql`中定义的自定义类型和Ent模式：

```hcl title="atlas.hcl"
data "composite_schema" "app" {
  # Load first custom types first.
  schema "public" {
    url = "file://schema.sql"
  }
  # Second, load the Ent schema.
  schema "public" {
    url = "ent://ent/schema"
  }
}

env "local" {
  src = data.composite_schema.app.url
  dev = "docker://postgres/15/dev?search_path=public"
}
```

## 使用

完成模式设置后，可通过`atlas schema inspect`命令获取其表示形式，生成迁移文件，应用到数据库等。以下是Atlas的入门命令示例：

#### 检查模式

`atlas schema inspect`命令通常用于检查数据库，但也可用于检查`composite_schema`并打印其SQL表示：

```shell
atlas schema inspect \
  --env local \
  --url env://src \
  --format '{{ sql . }}'
```

该命令将输出如下SQL。注意`address`复合类型在模式中的定义先于其在`address`字段中的使用：

```sql
-- Create composite type "address"
CREATE TYPE "address" AS ("street" text, "city" text);
-- Create "users" table
CREATE TABLE "users" ("id" bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY, "address" "address" NOT NULL, PRIMARY KEY ("id"));
```

#### 生成模式迁移

运行以下命令为模式生成迁移：

```shell
atlas migrate diff \
  --env local
```

注意新生成的迁移文件包含以下内容：

```sql title="migrations/20240712090543.sql"
-- Create composite type "address"
CREATE TYPE "address" AS ("street" text, "city" text);
-- Create "users" table
CREATE TABLE "users" ("id" bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY, "address" "address" NOT NULL, PRIMARY KEY ("id"));
```

#### 应用迁移

运行以下命令将生成的迁移应用到数据库：

```
atlas migrate apply \
  --env local \
  --url "postgres://postgres:pass@localhost:5432/database?search_path=public&sslmode=disable"
```

:::info[直接向数据库应用模式]

有时需要直接将模式应用到数据库而无需生成迁移文件，例如在测试模式变更或启动测试数据库等场景中。此时可以使用以下命令直接将模式应用到数据库：

```shell
atlas schema apply \
  --env local \
  --url "postgres://postgres:pass@localhost:5432/database?search_path=public&sslmode=disable"
```

或使用 [Atlas Go SDK](https://github.com/ariga/atlas-go-sdk)：

```go
ac, err := atlasexec.NewClient(".", "atlas")
if err != nil {
	log.Fatalf("failed to initialize client: %w", err)
}
// 自动用目标模式更新数据库
// 另一种方式是手动使用 'migrate apply' 或 'schema apply'
if _, err := ac.SchemaApply(ctx, &atlasexec.SchemaApplyParams{
	Env: "local",
	URL: "postgres://postgres:pass@localhost:5432/database?search_path=public&sslmode=disable",
	AutoApprove: true,
}); err != nil {
    log.Fatalf("failed to apply schema changes: %w", err)
}
```

:::

本指南的代码可在 [GitHub](https://github.com/ent/ent/tree/master/examples/compositetypes) 获取。